#!/bin/bash
set -euo pipefail

usage() {
  echo "Usage: scripts/worktree <name> [--no-claude] [--fresh-db]"
  echo ""
  echo "Creates a git worktree at .worktrees/<name> with branch feature/<name>,"
  echo "copies .env.local and local.db, installs dependencies, and launches claude."
  echo ""
  echo "If the worktree already exists, cd into it and launch claude."
  echo ""
  echo "Options:"
  echo "  --no-claude   Skip launching claude (prints cd command instead)"
  echo "  --fresh-db    Start with an empty database instead of copying main's"
  exit 1
}

name=""
launch_claude=true
fresh_db=false

for arg in "$@"; do
  case "$arg" in
    --no-claude) launch_claude=false ;;
    --fresh-db) fresh_db=true ;;
    --help|-h) usage ;;
    -*) echo "Unknown option: $arg"; usage ;;
    *) name="$arg" ;;
  esac
done

if [ -z "$name" ]; then
  usage
fi

repo_root="$(git rev-parse --show-toplevel)"
worktree_dir="$repo_root/.worktrees/$name"
branch="feature/$name"

if [ -d "$worktree_dir" ]; then
  echo "Worktree already exists at .worktrees/$name"
else
  echo "Updating main branch..."
  git fetch origin main
  git rebase origin/main main

  echo "Creating worktree .worktrees/$name on branch $branch..."
  git worktree add -B "$branch" "$worktree_dir" main
  cp "$repo_root/.env.local" "$worktree_dir/"

  if [ "$fresh_db" = true ]; then
    echo "Starting with fresh database..."
  elif [ -f "$repo_root/local.db" ]; then
    echo "Copying database from main worktree..."
    cp "$repo_root/local.db" "$worktree_dir/"
  else
    echo "No local.db found in main worktree, starting fresh..."
    fresh_db=true
  fi

  cd "$worktree_dir"
  echo "Installing dependencies..."
  pnpm install

  if [ "$fresh_db" = true ]; then
    echo "Running migrations..."
    pnpm db:migrate
  fi
fi

if [ "$launch_claude" = true ]; then
  cd "$worktree_dir"
  exec claude --chrome --dangerously-skip-permissions
else
  echo ""
  echo "Ready! Run:"
  echo "  cd $worktree_dir"
fi
